version: '3.8'

services:
    # ===================================
    # Atriz API (Backend)
    # ===================================
    atriz-api:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                APP_NAME: atriz
                APP_PORT: 3001
                VERSION: v1
        ports:
            - '3001:3001'
        environment:
            - NODE_ENV=production
            - PORT=3001
            - VERSION=v1
            # Add your other environment variables here
            # - DATABASE_URL=postgresql://user:password@db:5432/atriz_core
            # - REDIS_URL=redis://redis:6379
        # Uncomment if you need PostgreSQL
        # depends_on:
        #   - db
        #   - redis
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:' + (process.env.PORT || 3001) + '/' + (process.env.VERSION || 'v1') + '/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                ]
            interval: 24h
            timeout: 10s
            retries: 3
            start_period: 40s

    # ===================================
    # FollowSite API
    # ===================================
    followsite-api:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                APP_NAME: followsite
                APP_PORT: 3002
                VERSION: v2
        ports:
            - '3002:3002'
        environment:
            - NODE_ENV=production
            - PORT=3002
            - VERSION=v2
            # Add your other environment variables here
            # - DATABASE_URL=postgresql://user:password@db:5432/followsite_db
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:' + (process.env.PORT || 3002) + '/' + (process.env.VERSION || 'v2') + '/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                ]
            interval: 30s
            timeout: 24h
            retries: 3
            start_period: 40s

    # ===================================
    # PShop API (POS System)
    # ===================================
    pshop-api:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                APP_NAME: pshop
                APP_PORT: 3003
                VERSION: v1
        ports:
            - '3003:3003'
        environment:
            - NODE_ENV=production
            - PORT=3003
            - VERSION=v1
            # Add your other environment variables here
            # - DATABASE_URL=postgresql://user:password@db:5432/pshop_db
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:' + (process.env.PORT || 3003) + '/' + (process.env.VERSION || 'v1') + '/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                ]
            interval: 24h
            timeout: 10s
            retries: 3
            start_period: 40s

    # Uncomment if you need PostgreSQL
    # db:
    #   image: timescale/timescaledb:latest-pg16
    #   environment:
    #     - POSTGRES_USER=postgres
    #     - POSTGRES_PASSWORD=postgres
    #     - POSTGRES_DB=atriz_core
    #   ports:
    #     - "5432:5432"
    #   volumes:
    #     - postgres_data:/var/lib/postgresql/data
    #   restart: unless-stopped

    # Uncomment if you need Redis
    # redis:
    #   image: redis:7-alpine
    #   ports:
    #     - "6379:6379"
    #   volumes:
    #     - redis_data:/data
    #   restart: unless-stopped
# volumes:
#   postgres_data:
#   redis_data:
